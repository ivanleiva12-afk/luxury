<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sala Oscura ‚Äî Foro de Discusi√≥n</title>
  <meta name="description" content="Foro de discusi√≥n exclusivo para adultos. Calificaciones, recomendaciones y m√°s." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Montserrat:wght@600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="assets/logo.svg" type="image/svg+xml" />
  <style>
    :root {
      --gold: #D4AF37;
      --bg: #0A0A0A;
      --text: #FFFFFF;
      --muted: #888888;
    }
    
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
    }
    
    /* Header */
    .foro-header {
      background: rgba(10,10,10,0.98);
      border-bottom: 1px solid rgba(212,175,55,0.15);
      padding: 16px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .foro-header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .foro-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
    }
    
    .foro-logo img {
      height: 40px;
    }
    
    .foro-logo-text {
      font-family: 'Playfair Display', serif;
      font-size: 24px;
      color: var(--gold);
    }
    
    .foro-nav {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    
    .foro-nav-link {
      color: var(--muted);
      text-decoration: none;
      font-size: 14px;
      transition: color 200ms;
    }
    
    .foro-nav-link:hover {
      color: var(--gold);
    }
    
    .foro-user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .foro-user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(212,175,55,0.2);
      border: 2px solid var(--gold);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--gold);
      font-size: 14px;
    }
    
    .foro-user-name {
      color: var(--text);
      font-weight: 600;
      font-size: 14px;
    }
    
    .foro-user-badge {
      background: var(--gold);
      color: #000;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
    }
    
    /* Main Container */
    .foro-main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 24px;
    }
    
    /* Hero Section */
    .foro-hero {
      text-align: center;
      margin-bottom: 48px;
      padding: 60px 24px;
      background: linear-gradient(180deg, rgba(212,175,55,0.1) 0%, transparent 100%);
      border-radius: 16px;
      border: 1px solid rgba(212,175,55,0.15);
    }
    
    .foro-hero-title {
      font-family: 'Playfair Display', serif;
      font-size: 48px;
      color: var(--text);
      margin: 0 0 16px 0;
    }
    
    .foro-hero-subtitle {
      color: var(--muted);
      font-size: 18px;
      margin: 0 0 32px 0;
    }
    
    /* Buttons */
    .btn-primary {
      background: var(--gold);
      color: #000;
      border: none;
      padding: 14px 32px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: all 200ms;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(212,175,55,0.3);
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: var(--text);
      border: 1px solid rgba(212,175,55,0.3);
      padding: 14px 32px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 200ms;
    }
    
    .btn-secondary:hover {
      background: rgba(212,175,55,0.15);
      border-color: var(--gold);
    }
    
    .btn-sm {
      padding: 8px 16px;
      font-size: 13px;
    }
    
    /* Auth Section */
    .auth-section {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal-content {
      background: #0A0A0A;
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 16px;
      padding: 32px;
      max-width: 480px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    
    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      color: var(--muted);
      font-size: 28px;
      cursor: pointer;
      line-height: 1;
    }
    
    .modal-close:hover {
      color: var(--text);
    }
    
    .modal-title {
      font-family: 'Playfair Display', serif;
      font-size: 28px;
      color: var(--gold);
      margin: 0 0 8px 0;
    }
    
    .modal-subtitle {
      color: var(--muted);
      font-size: 14px;
      margin: 0 0 24px 0;
    }
    
    /* Form */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      color: var(--text);
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .form-input {
      width: 100%;
      background: rgba(255,255,255,0.05);
      color: var(--text);
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 15px;
      font-family: inherit;
      transition: all 200ms;
      box-sizing: border-box;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--gold);
      background: rgba(212,175,55,0.05);
    }
    
    .form-input::placeholder {
      color: var(--muted);
    }
    
    .form-hint {
      color: var(--muted);
      font-size: 12px;
      margin-top: 6px;
    }
    
    .form-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .form-checkbox input {
      margin-top: 3px;
      accent-color: var(--gold);
    }
    
    .form-checkbox label {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }
    
    .form-divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 24px 0;
    }
    
    .form-divider::before,
    .form-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: rgba(212,175,55,0.2);
    }
    
    .form-divider span {
      color: var(--muted);
      font-size: 13px;
    }
    
    .age-warning {
      background: rgba(220,38,38,0.15);
      border: 1px solid rgba(220,38,38,0.3);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .age-warning-title {
      color: #DC2626;
      font-weight: 700;
      font-size: 14px;
      margin: 0 0 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .age-warning-text {
      color: var(--muted);
      font-size: 13px;
      margin: 0;
      line-height: 1.5;
    }
    
    /* Foro Content */
    .foro-content {
      display: none;
    }
    
    .foro-content.active {
      display: block;
    }
    
    .foro-welcome {
      background: rgba(212,175,55,0.1);
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 32px;
    }
    
    .foro-welcome-title {
      color: var(--gold);
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 8px 0;
    }
    
    .foro-welcome-text {
      color: var(--muted);
      font-size: 14px;
      margin: 0;
    }
    
    /* Categories */
    .foro-categories {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    
    .foro-category {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(212,175,55,0.15);
      border-radius: 12px;
      padding: 24px;
      cursor: pointer;
      transition: all 200ms;
    }
    
    .foro-category:hover {
      border-color: var(--gold);
      background: rgba(212,175,55,0.05);
    }
    
    .foro-category.zona-clientas {
      background: rgba(147,112,219,0.08);
      border-color: rgba(147,112,219,0.3);
    }
    
    .foro-category.zona-clientas:hover {
      border-color: #9370DB;
      background: rgba(147,112,219,0.15);
    }
    
    .foro-category.zona-clientas .foro-category-title {
      color: #9370DB;
    }
    
    .foro-category-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }
    
    .foro-category-title {
      color: var(--text);
      font-weight: 700;
      font-size: 18px;
      margin: 0 0 8px 0;
    }
    
    .foro-category-desc {
      color: var(--muted);
      font-size: 14px;
      margin: 0;
    }
    
    .foro-category-count {
      color: var(--gold);
      font-size: 13px;
      margin-top: 12px;
    }
    
    /* Posts Section */
    .foro-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .foro-section-title {
      font-family: 'Playfair Display', serif;
      font-size: 28px;
      color: var(--text);
      margin: 0;
    }
    
    /* Posts List */
    .foro-posts {
      display: grid;
      gap: 16px;
    }
    
    .foro-post {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(212,175,55,0.15);
      border-radius: 12px;
      padding: 20px;
      transition: all 200ms;
    }
    
    .foro-post:hover {
      border-color: rgba(212,175,55,0.3);
    }
    
    .foro-post.escort-post {
      border: 2px solid var(--gold);
      background: rgba(212,175,55,0.08);
    }
    
    .foro-post-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .foro-post-author {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .foro-post-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(212,175,55,0.2);
      border: 2px solid rgba(212,175,55,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--gold);
    }
    
    .foro-post.escort-post .foro-post-avatar {
      border-color: var(--gold);
    }
    
    .foro-post-author-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .foro-post-author-name {
      color: var(--text);
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .foro-post-date {
      color: var(--muted);
      font-size: 12px;
    }
    
    .foro-post-category {
      background: rgba(212,175,55,0.15);
      color: var(--gold);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .foro-post-title {
      color: var(--gold);
      font-size: 18px;
      font-weight: 700;
      margin: 0 0 12px 0;
    }
    
    .foro-post-content {
      color: var(--text);
      font-size: 14px;
      line-height: 1.7;
      margin-bottom: 16px;
    }
    
    .foro-post-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 16px;
      border-top: 1px solid rgba(212,175,55,0.1);
    }
    
    .foro-post-stats {
      display: flex;
      gap: 20px;
    }
    
    .foro-post-stat {
      color: var(--muted);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .foro-post-actions {
      display: flex;
      gap: 8px;
    }
    
    .foro-post-action {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(212,175,55,0.2);
      color: var(--muted);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 200ms;
    }
    
    .foro-post-action:hover {
      background: rgba(212,175,55,0.15);
      color: var(--gold);
      border-color: var(--gold);
    }
    
    /* Rating Display */
    .foro-rating {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(212,175,55,0.15);
      padding: 8px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    
    .foro-rating-score {
      color: var(--gold);
      font-size: 24px;
      font-weight: 700;
    }
    
    .foro-rating-max {
      color: var(--muted);
      font-size: 14px;
    }
    
    /* Rating Input */
    .rating-input {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    
    .rating-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: 1px solid rgba(212,175,55,0.3);
      background: rgba(255,255,255,0.05);
      color: var(--muted);
      font-weight: 600;
      cursor: pointer;
      transition: all 200ms;
    }
    
    .rating-btn:hover,
    .rating-btn.selected {
      background: var(--gold);
      color: #000;
      border-color: var(--gold);
    }
    
    /* Replies */
    .foro-replies {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(212,175,55,0.1);
    }
    
    .foro-replies-title {
      color: var(--gold);
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 12px 0;
    }
    
    .foro-reply {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }
    
    .foro-reply:last-child {
      margin-bottom: 0;
    }
    
    .foro-reply-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .foro-reply-author {
      color: var(--text);
      font-weight: 600;
      font-size: 13px;
    }
    
    .foro-reply-date {
      color: var(--muted);
      font-size: 11px;
    }
    
    .foro-reply-content {
      color: var(--text);
      font-size: 13px;
      line-height: 1.6;
    }
    
    /* Menciones @ */
    .mention-link {
      color: var(--gold);
      background: rgba(212,175,55,0.15);
      padding: 2px 6px;
      border-radius: 4px;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 200ms;
    }
    
    .mention-link:hover {
      background: rgba(212,175,55,0.3);
      color: #fff;
    }
    
    /* Autocomplete dropdown */
    .mention-autocomplete {
      position: absolute;
      background: #1a1a1a;
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1001;
      min-width: 200px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      display: none;
    }
    
    .mention-autocomplete.active {
      display: block;
    }
    
    .mention-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 200ms;
    }
    
    .mention-item:hover,
    .mention-item.selected {
      background: rgba(212,175,55,0.15);
    }
    
    .mention-item-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(212,175,55,0.2);
      border: 2px solid var(--gold);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--gold);
      font-size: 12px;
    }
    
    .mention-item-info {
      display: flex;
      flex-direction: column;
    }
    
    .mention-item-name {
      color: var(--text);
      font-weight: 600;
      font-size: 14px;
    }
    
    .mention-item-badge {
      color: var(--gold);
      font-size: 11px;
    }
    
    .mention-empty {
      padding: 12px;
      color: var(--muted);
      font-size: 13px;
      text-align: center;
    }
    
    /* Textarea container para autocomplete */
    .textarea-container {
      position: relative;
    }

    /* Empty State */
    .foro-empty {
      text-align: center;
      padding: 60px 24px;
      color: var(--muted);
    }
    
    .foro-empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .foro-empty-text {
      font-size: 16px;
      margin: 0;
    }
    
    /* Footer */
    .foro-footer {
      border-top: 1px solid rgba(212,175,55,0.15);
      padding: 32px 0;
      margin-top: 60px;
    }
    
    .foro-footer-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .foro-footer-copy {
      color: var(--muted);
      font-size: 13px;
    }
    
    .foro-footer-links {
      display: flex;
      gap: 24px;
    }
    
    .foro-footer-link {
      color: var(--muted);
      text-decoration: none;
      font-size: 13px;
      transition: color 200ms;
    }
    
    .foro-footer-link:hover {
      color: var(--gold);
    }
    
    /* Tabs */
    .auth-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }
    
    .auth-tab {
      flex: 1;
      padding: 12px;
      border: none;
      background: rgba(255,255,255,0.05);
      color: var(--muted);
      font-weight: 600;
      font-size: 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 200ms;
    }
    
    .auth-tab.active {
      background: rgba(212,175,55,0.2);
      color: var(--gold);
    }
    
    /* ========================================
       RESPONSIVE M√ìVIL - SALA OSCURA
       ======================================== */
    @media (max-width: 768px) {
      /* Header */
      .foro-header-inner {
        flex-direction: column;
        gap: 12px;
        padding: 0 12px;
      }
      
      .foro-nav {
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
      }
      
      .foro-logo-text {
        font-size: 20px;
      }
      
      .foro-logo img {
        height: 32px;
      }
      
      /* Hero */
      .foro-hero {
        padding: 30px 16px;
        margin-bottom: 24px;
      }
      
      .foro-hero-title {
        font-size: 28px;
      }
      
      .foro-hero-subtitle {
        font-size: 14px;
      }
      
      /* Main */
      .foro-main {
        padding: 20px 12px;
      }
      
      /* Categor√≠as */
      .foro-categories {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .foro-category {
        padding: 14px;
      }
      
      .foro-category-icon {
        font-size: 24px;
        margin-bottom: 8px;
      }
      
      .foro-category-title {
        font-size: 13px;
      }
      
      .foro-category-desc {
        font-size: 11px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      
      .foro-category-count {
        font-size: 11px;
      }
      
      /* Welcome */
      .foro-welcome {
        padding: 16px;
        margin-bottom: 20px;
      }
      
      .foro-welcome-title {
        font-size: 16px;
      }
      
      .foro-welcome-text {
        font-size: 12px;
      }
      
      /* Posts */
      .foro-section-header {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      
      .foro-section-title {
        font-size: 18px;
      }
      
      .foro-post {
        padding: 14px;
        margin-bottom: 12px;
      }
      
      .foro-post-compact {
        padding: 12px;
      }
      
      .foro-post-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
      
      .foro-post-avatar {
        width: 32px;
        height: 32px;
        font-size: 12px;
      }
      
      .foro-post-author-name {
        font-size: 13px;
      }
      
      .foro-post-date {
        font-size: 10px;
      }
      
      .foro-post-category {
        font-size: 10px;
        padding: 3px 8px;
      }
      
      .foro-post-title {
        font-size: 15px;
        margin: 10px 0;
      }
      
      .foro-post-content {
        font-size: 13px;
        line-height: 1.5;
      }
      
      .foro-post-footer {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
        padding-top: 12px;
      }
      
      .foro-post-stats {
        justify-content: flex-start;
      }
      
      .foro-post-stat {
        font-size: 12px;
      }
      
      .foro-post-actions {
        display: flex;
        gap: 8px;
      }
      
      .foro-post-action {
        flex: 1;
        padding: 10px 12px;
        font-size: 12px;
        text-align: center;
      }
      
      /* Respuestas */
      .foro-replies {
        margin-top: 16px;
        padding-top: 16px;
      }
      
      .foro-replies-title {
        font-size: 14px;
      }
      
      .foro-reply {
        padding: 12px;
        margin-bottom: 10px;
      }
      
      .foro-reply-header {
        flex-wrap: wrap;
        gap: 6px;
      }
      
      .foro-reply-author {
        font-size: 12px;
      }
      
      .foro-reply-date {
        font-size: 10px;
      }
      
      .foro-reply-content {
        font-size: 13px;
      }
      
      /* Modales */
      .modal-content {
        padding: 20px 16px;
        margin: 10px;
        max-height: 85vh;
        border-radius: 12px;
      }
      
      .modal-title {
        font-size: 22px;
      }
      
      .modal-subtitle {
        font-size: 13px;
      }
      
      .modal-close {
        top: 12px;
        right: 12px;
        font-size: 24px;
      }
      
      /* Formularios */
      .form-group {
        margin-bottom: 16px;
      }
      
      .form-label {
        font-size: 13px;
        margin-bottom: 6px;
      }
      
      .form-input {
        padding: 10px 12px;
        font-size: 14px;
      }
      
      .form-input textarea {
        min-height: 80px;
      }
      
      .form-checkbox label {
        font-size: 12px;
      }
      
      .form-hint {
        font-size: 11px;
      }
      
      /* Botones */
      .btn-primary,
      .btn-secondary {
        padding: 12px 20px;
        font-size: 14px;
        width: 100%;
      }
      
      .btn-sm {
        padding: 8px 12px;
        font-size: 12px;
        width: auto;
      }
      
      /* Auth tabs */
      .auth-tabs {
        gap: 8px;
      }
      
      .auth-tab {
        padding: 10px;
        font-size: 13px;
      }
      
      /* Footer */
      .foro-footer {
        padding: 24px 12px;
      }
      
      .foro-footer-inner {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }
      
      .foro-footer-links {
        flex-wrap: wrap;
        justify-content: center;
        gap: 12px;
      }
      
      .foro-footer-link {
        font-size: 12px;
      }
      
      /* Age warning */
      .age-warning {
        padding: 12px;
      }
      
      .age-warning-title {
        font-size: 13px;
      }
      
      .age-warning-text {
        font-size: 12px;
      }
      
      /* Ratings detallados */
      .foro-detailed-ratings {
        padding: 12px !important;
      }
      
      .foro-detailed-ratings > div {
        grid-template-columns: 1fr !important;
        gap: 8px !important;
      }
      
      /* Empty state */
      .foro-empty {
        padding: 30px 16px;
      }
      
      .foro-empty-icon {
        font-size: 40px;
      }
      
      .foro-empty-text {
        font-size: 14px;
      }
    }
    
    /* Pantallas muy peque√±as */
    @media (max-width: 480px) {
      .foro-categories {
        grid-template-columns: 1fr;
      }
      
      .foro-hero-title {
        font-size: 24px;
      }
      
      .foro-post-title {
        font-size: 14px;
      }
      
      .modal-content {
        padding: 16px 12px;
      }
      
      .modal-title {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="foro-header">
    <div class="foro-header-inner">
      <a href="home" class="foro-logo">
        <img src="assets/logo-premium.png" alt="Logo" onerror="this.style.display='none'" />
        <span class="foro-logo-text">Sala Oscura</span>
      </a>
      
      <nav class="foro-nav">
        <a href="#" class="foro-nav-link" onclick="irAInicio(event)">Inicio</a>
        
        <!-- Usuario no logueado -->
        <div id="nav-auth-buttons">
          <button class="btn-secondary btn-sm" onclick="openModal('login')">Iniciar Sesi√≥n</button>
        </div>
        
        <!-- Usuario logueado -->
        <div id="nav-user-info" class="foro-user-info" style="display: none;">
          <div class="foro-user-avatar" id="user-avatar">U</div>
          <div>
            <div class="foro-user-name" id="user-display-name">Usuario</div>
            <span class="foro-user-badge" id="user-badge" style="display: none;">ESCORT</span>
          </div>
          <button class="btn-secondary btn-sm" onclick="cerrarSesion()">Salir</button>
        </div>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="foro-main">
    <!-- Hero Section (Solo visible cuando no est√° logueado) -->
    <section class="foro-hero" id="hero-section">
      <h1 class="foro-hero-title">Sala Oscura</h1>
      <p class="foro-hero-subtitle">Foro de discusi√≥n exclusivo. Comparte experiencias, califica y recomienda.</p>
      
      <div class="auth-section">
        <button class="btn-primary" onclick="openModal('login')">Iniciar Sesi√≥n</button>
        <button class="btn-secondary" onclick="openModal('register')">Crear Cuenta</button>
      </div>
    </section>

    <!-- Foro Content (Solo visible cuando est√° logueado) -->
    <section class="foro-content" id="foro-content">
      <!-- Welcome Banner -->
      <div class="foro-welcome" id="welcome-banner">
        <h3 class="foro-welcome-title">¬°Bienvenido/a, <span id="welcome-name">Usuario</span>!</h3>
        <p class="foro-welcome-text">Participa en las discusiones, comparte tus experiencias y conecta con la comunidad.</p>
      </div>

      <!-- Categories -->
      <div class="foro-categories">
        <div class="foro-category" onclick="filterByCategory('general')">
          <div class="foro-category-icon">üí¨</div>
          <h3 class="foro-category-title">Discusi√≥n General</h3>
          <p class="foro-category-desc">Conversaciones libres sobre cualquier tema</p>
          <div class="foro-category-count" id="count-general">0 temas</div>
        </div>
        
        <div class="foro-category" onclick="filterByCategory('calificaciones')">
          <div class="foro-category-icon">‚≠ê</div>
          <h3 class="foro-category-title">Calificaciones</h3>
          <p class="foro-category-desc">Califica habitaci√≥n, chica, servicio y m√°s</p>
          <div class="foro-category-count" id="count-calificaciones">0 temas</div>
        </div>
        
        <div class="foro-category" onclick="filterByCategory('recomendaciones')">
          <div class="foro-category-icon">üëç</div>
          <h3 class="foro-category-title">Recomendaciones</h3>
          <p class="foro-category-desc">Recomienda y descubre nuevas chicas</p>
          <div class="foro-category-count" id="count-recomendaciones">0 temas</div>
        </div>
        
        <div class="foro-category" onclick="filterByCategory('experiencias')">
          <div class="foro-category-icon">üìñ</div>
          <h3 class="foro-category-title">Experiencias</h3>
          <p class="foro-category-desc">Comparte tus experiencias con la comunidad</p>
          <div class="foro-category-count" id="count-experiencias">0 temas</div>
        </div>
        
        <div class="foro-category zona-clientas" onclick="openZonaClientas()">
          <div class="foro-category-icon">üë†</div>
          <h3 class="foro-category-title">Zona Clientas</h3>
          <p class="foro-category-desc">Espacio exclusivo para clientas verificadas</p>
          <div class="foro-category-count" id="count-zonaclientas">üîí Acceso exclusivo</div>
        </div>
      </div>

      <!-- Posts Section -->
      <div class="foro-section-header">
        <h2 class="foro-section-title" id="section-title">Publicaciones Recientes</h2>
        <button class="btn-primary btn-sm" onclick="openModal('newpost')">+ Nuevo Tema</button>
      </div>
      
      <!-- Filtro de Menciones -->
      <div class="mention-filter-section">
        <div class="mention-filter-container">
          <div class="mention-search-wrapper">
            <span class="mention-search-icon">@</span>
            <input 
              type="text" 
              id="mention-filter-input" 
              class="mention-filter-input" 
              placeholder="Buscar por menciones... ej: @nombre"
              autocomplete="off"
            />
            <button class="mention-filter-btn" onclick="applyMentionFilter()">
              <span>üîç</span> Buscar
            </button>
          </div>
          <div id="mention-filter-active" class="mention-filter-active" style="display: none;">
            <span class="mention-filter-tag">
              <span id="mention-filter-name"></span>
              <button class="mention-filter-clear" onclick="clearMentionFilter()">‚úï</button>
            </span>
          </div>
        </div>
      </div>

      <!-- Posts destacados de Escorts -->
      <div id="escort-posts-section" style="margin-bottom: 32px;">
        <h3 style="color: var(--gold); font-size: 16px; margin-bottom: 16px;">‚ú® Destacados de Escorts</h3>
        <div class="foro-posts" id="escort-posts-list">
          <!-- Posts de escorts -->
        </div>
      </div>

      <!-- Posts generales -->
      <div id="general-posts-section">
        <h3 style="color: var(--muted); font-size: 16px; margin-bottom: 16px;">üí¨ Discusiones de la Comunidad</h3>
        <div class="foro-posts" id="posts-list">
          <!-- Posts generales -->
        </div>
      </div>

      <!-- Empty State -->
      <div class="foro-empty" id="empty-state" style="display: none;">
        <div class="foro-empty-icon">üì≠</div>
        <p class="foro-empty-text">No hay publicaciones en esta categor√≠a</p>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="foro-footer">
    <div class="foro-footer-inner">
      <p class="foro-footer-copy">¬© <span id="year"></span> Sala Oscura. Todos los derechos reservados.</p>
      <div class="foro-footer-links">
        <a href="home" class="foro-footer-link">Inicio</a>
        <a href="services" class="foro-footer-link">Servicios</a>
        <a href="about" class="foro-footer-link">Nosotros</a>
      </div>
    </div>
  </footer>

  <!-- Modal: Login -->
  <div class="modal-overlay" id="modal-login">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal('login')">&times;</button>
      <h2 class="modal-title">Iniciar Sesi√≥n</h2>
      <p class="modal-subtitle">Ingresa a tu cuenta para participar en el foro</p>
      
      <!-- Tabs -->
      <div class="auth-tabs">
        <button class="auth-tab active" id="tab-usuario" onclick="switchLoginTab('usuario')">Usuario</button>
        <button class="auth-tab" id="tab-escort" onclick="switchLoginTab('escort')">Soy Escort</button>
      </div>
      
      <form id="login-form" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label class="form-label" for="login-email">Correo electr√≥nico</label>
          <input type="email" class="form-input" id="login-email" placeholder="tu@email.com" required />
        </div>
        
        <div class="form-group" id="login-password-group">
          <label class="form-label" for="login-password">Contrase√±a</label>
          <input type="password" class="form-input" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
        </div>
        
        <button type="submit" class="btn-primary" style="width: 100%;">Ingresar</button>
      </form>
      
      <div class="form-divider" id="login-no-cuenta">
        <span>¬øNo tienes cuenta?</span>
      </div>
      
      <button class="btn-secondary" id="login-crear-cuenta" style="width: 100%;" onclick="closeModal('login'); openModal('register');">
        Crear cuenta de Usuario
      </button>
      
      <p style="color: var(--muted); font-size: 12px; text-align: center; margin-top: 16px;">
        Si eres escort, usa el correo con el que te registraste. No necesitas contrase√±a.
      </p>
    </div>
  </div>

  <!-- Modal: Register -->
  <div class="modal-overlay" id="modal-register">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal('register')">&times;</button>
      <h2 class="modal-title">Crear Cuenta</h2>
      <p class="modal-subtitle">√önete al foro de Sala Oscura</p>
      
      <!-- Age Warning -->
      <div class="age-warning">
        <h4 class="age-warning-title">‚ö†Ô∏è Advertencia de Edad</h4>
        <p class="age-warning-text">Este sitio es exclusivamente para mayores de 18 a√±os. Al crear una cuenta, confirmas que tienes la edad legal requerida.</p>
      </div>
      
      <form id="register-form" onsubmit="handleRegister(event)">
        <div class="form-group">
          <label class="form-label" for="reg-nombre">Nombre o Seud√≥nimo *</label>
          <input type="text" class="form-input" id="reg-nombre" placeholder="Tu nombre o apodo" required minlength="3" />
          <p class="form-hint">Este nombre ser√° visible para otros usuarios</p>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="reg-email">Correo electr√≥nico *</label>
          <input type="email" class="form-input" id="reg-email" placeholder="tu@email.com" required />
        </div>
        
        <div class="form-group">
          <label class="form-label" for="reg-edad">Edad *</label>
          <input type="number" class="form-input" id="reg-edad" placeholder="18" min="18" max="99" required />
        </div>
        
        <div class="form-group">
          <label class="form-label" for="reg-password">Contrase√±a *</label>
          <input type="password" class="form-input" id="reg-password" placeholder="M√≠nimo 6 caracteres" required minlength="6" />
        </div>
        
        <div class="form-checkbox">
          <input type="checkbox" id="reg-age-confirm" required />
          <label for="reg-age-confirm">Confirmo que soy mayor de 18 a√±os y acepto los t√©rminos de uso del foro.</label>
        </div>
        
        <button type="submit" class="btn-primary" style="width: 100%;">Crear Cuenta</button>
      </form>
      
      <div class="form-divider">
        <span>¬øYa tienes cuenta?</span>
      </div>
      
      <button class="btn-secondary" style="width: 100%;" onclick="closeModal('register'); openModal('login');">
        Iniciar Sesi√≥n
      </button>
    </div>
  </div>

  <!-- Modal: New Post -->
  <div class="modal-overlay" id="modal-newpost">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal('newpost')">&times;</button>
      <h2 class="modal-title">Crear Nuevo Tema</h2>
      <p class="modal-subtitle">Comparte tu opini√≥n con la comunidad</p>
      
      <form id="newpost-form" onsubmit="handleNewPost(event)">
        <div class="form-group">
          <label class="form-label" for="post-category">Categor√≠a *</label>
          <select class="form-input" id="post-category" required onchange="handleCategoryChange()">
            <option value="">Seleccionar categor√≠a...</option>
            <option value="general">üí¨ Discusi√≥n General</option>
            <option value="calificaciones">‚≠ê Calificaci√≥n</option>
            <option value="recomendaciones">üëç Recomendaci√≥n</option>
            <option value="experiencias">üìñ Experiencia</option>
            <option value="zonaclientas">üë† Zona Clientas</option>
          </select>
        </div>
        
        <div class="form-group" id="rating-group" style="display: none;">
          <label class="form-label">Calificaci√≥n Detallada (1-10)</label>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; color: var(--muted); font-size: 13px; margin-bottom: 6px;">üõèÔ∏è Habitaci√≥n / Lugar</label>
            <div class="rating-input" data-field="habitacion">
              <button type="button" class="rating-btn" data-rating="1">1</button>
              <button type="button" class="rating-btn" data-rating="2">2</button>
              <button type="button" class="rating-btn" data-rating="3">3</button>
              <button type="button" class="rating-btn" data-rating="4">4</button>
              <button type="button" class="rating-btn" data-rating="5">5</button>
              <button type="button" class="rating-btn" data-rating="6">6</button>
              <button type="button" class="rating-btn" data-rating="7">7</button>
              <button type="button" class="rating-btn" data-rating="8">8</button>
              <button type="button" class="rating-btn" data-rating="9">9</button>
              <button type="button" class="rating-btn" data-rating="10">10</button>
            </div>
            <input type="hidden" id="rating-habitacion" value="0" />
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; color: var(--muted); font-size: 13px; margin-bottom: 6px;">üíÉ La Chica (Apariencia f√≠sica)</label>
            <div class="rating-input" data-field="chica">
              <button type="button" class="rating-btn" data-rating="1">1</button>
              <button type="button" class="rating-btn" data-rating="2">2</button>
              <button type="button" class="rating-btn" data-rating="3">3</button>
              <button type="button" class="rating-btn" data-rating="4">4</button>
              <button type="button" class="rating-btn" data-rating="5">5</button>
              <button type="button" class="rating-btn" data-rating="6">6</button>
              <button type="button" class="rating-btn" data-rating="7">7</button>
              <button type="button" class="rating-btn" data-rating="8">8</button>
              <button type="button" class="rating-btn" data-rating="9">9</button>
              <button type="button" class="rating-btn" data-rating="10">10</button>
            </div>
            <input type="hidden" id="rating-chica" value="0" />
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; color: var(--muted); font-size: 13px; margin-bottom: 6px;">üî• Nivel del Servicio (Calidad √≠ntima)</label>
            <div class="rating-input" data-field="servicio">
              <button type="button" class="rating-btn" data-rating="1">1</button>
              <button type="button" class="rating-btn" data-rating="2">2</button>
              <button type="button" class="rating-btn" data-rating="3">3</button>
              <button type="button" class="rating-btn" data-rating="4">4</button>
              <button type="button" class="rating-btn" data-rating="5">5</button>
              <button type="button" class="rating-btn" data-rating="6">6</button>
              <button type="button" class="rating-btn" data-rating="7">7</button>
              <button type="button" class="rating-btn" data-rating="8">8</button>
              <button type="button" class="rating-btn" data-rating="9">9</button>
              <button type="button" class="rating-btn" data-rating="10">10</button>
            </div>
            <input type="hidden" id="rating-servicio" value="0" />
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; color: var(--muted); font-size: 13px; margin-bottom: 6px;">üßº Higiene</label>
            <div class="rating-input" data-field="higiene">
              <button type="button" class="rating-btn" data-rating="1">1</button>
              <button type="button" class="rating-btn" data-rating="2">2</button>
              <button type="button" class="rating-btn" data-rating="3">3</button>
              <button type="button" class="rating-btn" data-rating="4">4</button>
              <button type="button" class="rating-btn" data-rating="5">5</button>
              <button type="button" class="rating-btn" data-rating="6">6</button>
              <button type="button" class="rating-btn" data-rating="7">7</button>
              <button type="button" class="rating-btn" data-rating="8">8</button>
              <button type="button" class="rating-btn" data-rating="9">9</button>
              <button type="button" class="rating-btn" data-rating="10">10</button>
            </div>
            <input type="hidden" id="rating-higiene" value="0" />
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; color: var(--muted); font-size: 13px; margin-bottom: 6px;">üòä Trato / Actitud</label>
            <div class="rating-input" data-field="trato">
              <button type="button" class="rating-btn" data-rating="1">1</button>
              <button type="button" class="rating-btn" data-rating="2">2</button>
              <button type="button" class="rating-btn" data-rating="3">3</button>
              <button type="button" class="rating-btn" data-rating="4">4</button>
              <button type="button" class="rating-btn" data-rating="5">5</button>
              <button type="button" class="rating-btn" data-rating="6">6</button>
              <button type="button" class="rating-btn" data-rating="7">7</button>
              <button type="button" class="rating-btn" data-rating="8">8</button>
              <button type="button" class="rating-btn" data-rating="9">9</button>
              <button type="button" class="rating-btn" data-rating="10">10</button>
            </div>
            <input type="hidden" id="rating-trato" value="0" />
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; color: var(--muted); font-size: 13px; margin-bottom: 6px;">üí∞ Relaci√≥n Calidad-Precio</label>
            <div class="rating-input" data-field="precio">
              <button type="button" class="rating-btn" data-rating="1">1</button>
              <button type="button" class="rating-btn" data-rating="2">2</button>
              <button type="button" class="rating-btn" data-rating="3">3</button>
              <button type="button" class="rating-btn" data-rating="4">4</button>
              <button type="button" class="rating-btn" data-rating="5">5</button>
              <button type="button" class="rating-btn" data-rating="6">6</button>
              <button type="button" class="rating-btn" data-rating="7">7</button>
              <button type="button" class="rating-btn" data-rating="8">8</button>
              <button type="button" class="rating-btn" data-rating="9">9</button>
              <button type="button" class="rating-btn" data-rating="10">10</button>
            </div>
            <input type="hidden" id="rating-precio" value="0" />
          </div>
          
          <div style="background: rgba(212,175,55,0.1); padding: 12px; border-radius: 8px; margin-top: 16px;">
            <span style="color: var(--muted); font-size: 13px;">Promedio General: </span>
            <span id="rating-promedio" style="color: var(--gold); font-weight: 700; font-size: 16px;">0</span>
            <span style="color: var(--muted); font-size: 13px;">/10</span>
          </div>
          <input type="hidden" id="post-rating" value="0" />
        </div>
        
        <div class="form-group">
          <label class="form-label" for="post-title">T√≠tulo *</label>
          <input type="text" class="form-input" id="post-title" placeholder="T√≠tulo de tu publicaci√≥n" required />
        </div>
        
        <div class="form-group">
          <label class="form-label" for="post-content">Contenido * <span style="color: var(--muted); font-weight: 400; font-size: 12px;">(usa @ para mencionar)</span></label>
          <div class="textarea-container">
            <textarea class="form-input" id="post-content" rows="6" placeholder="Escribe tu mensaje aqu√≠... Usa @nombre para mencionar a alguien" required style="resize: vertical;"></textarea>
            <div class="mention-autocomplete" id="post-autocomplete"></div>
          </div>
        </div>
        
        <button type="submit" class="btn-primary" style="width: 100%;">Publicar</button>
      </form>
    </div>
  </div>

  <!-- Modal: Reply -->
  <div class="modal-overlay" id="modal-reply">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal('reply')">&times;</button>
      <h2 class="modal-title">Responder</h2>
      
      <form id="reply-form" onsubmit="handleReply(event)">
        <input type="hidden" id="reply-post-id" />
        
        <div class="form-group">
          <label class="form-label" for="reply-content">Tu respuesta <span style="color: var(--muted); font-weight: 400; font-size: 12px;">(usa @ para mencionar)</span></label>
          <div class="textarea-container">
            <textarea class="form-input" id="reply-content" rows="4" placeholder="Escribe tu respuesta... Usa @nombre para mencionar" required style="resize: vertical;"></textarea>
            <div class="mention-autocomplete" id="reply-autocomplete"></div>
          </div>
        </div>
        
        <button type="submit" class="btn-primary" style="width: 100%;">Enviar Respuesta</button>
      </form>
    </div>
  </div>

  <script>
    // ========================================
    // VARIABLES GLOBALES
    // ========================================
    let currentUser = JSON.parse(localStorage.getItem('salaOscuraCurrentUser') || 'null');
    let loginType = 'usuario'; // 'usuario' o 'escort'
    let currentFilter = 'todos';
    let mentionFilterActive = false;
    let mentionFilterName = '';

    // ========================================
    // INICIALIZACI√ìN
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('year').textContent = new Date().getFullYear();
      initTestUsers();
      initRatingButtons();
      updateUI();
      
      // Verificar si viene desde una menci√≥n con post espec√≠fico
      const urlParams = new URLSearchParams(window.location.search);
      const postId = urlParams.get('post');
      const filterType = urlParams.get('filter');
      const filterName = urlParams.get('name');
      
      if (filterType === 'mentions' && filterName) {
        // Filtrar por menciones de un perfil
        mentionFilterActive = true;
        mentionFilterName = decodeURIComponent(filterName);
        loadPostsFilteredByMention(mentionFilterName);
      } else if (postId) {
        // Mostrar post espec√≠fico
        showSpecificPost(parseInt(postId));
      } else {
        loadPosts();
      }
      
      updateCategoryCounts();
    });

    // ========================================
    // MOSTRAR POST ESPEC√çFICO (desde menciones)
    // ========================================
    function showSpecificPost(postId) {
      const posts = JSON.parse(localStorage.getItem('salaOscuraPosts') || '[]');
      const post = posts.find(p => p.id === postId);
      
      if (!post) {
        alert('El hilo no fue encontrado');
        loadPosts();
        return;
      }
      
      // Verificar acceso si es zona clientas (solo escorts pueden ver)
      if (post.categoria === 'zonaclientas') {
        if (!currentUser || currentUser.tipo !== 'escort') {
          alert('‚ö†Ô∏è Acceso restringido\n\nEste hilo es de Zona Clientas, exclusiva para Escorts.');
          loadPosts('todos');
          return;
        }
      }
      
      currentFilter = 'hilo';
      
      // Ocultar secci√≥n de escorts en vista de hilo √∫nico
      document.getElementById('escort-posts-section').style.display = 'none';
      
      // Mostrar solo el post espec√≠fico (expandido)
      const postsList = document.getElementById('posts-list');
      const emptyState = document.getElementById('empty-state');
      
      postsList.innerHTML = renderPost(post, true); // true = expandido
      emptyState.style.display = 'none';
      
      // Actualizar t√≠tulo con bot√≥n de volver
      document.getElementById('section-title').innerHTML = `
        <span style="display: flex; align-items: center; gap: 12px;">
          <button onclick="volverALista()" style="background: rgba(212,175,55,0.2); border: 1px solid rgba(212,175,55,0.3); color: #D4AF37; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            Volver
          </button>
          <span>üìå ${escapeHtml(post.titulo)}</span>
        </span>
      `;
      
      // Scroll al post
      postsList.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ========================================
    // FILTRAR POR MENCIONES DE UN PERFIL
    // ========================================
    function loadPostsFilteredByMention(profileName) {
      const posts = JSON.parse(localStorage.getItem('salaOscuraPosts') || '[]');
      const searchName = profileName.toLowerCase();
      
      // Filtrar posts donde se menciona al perfil
      const filteredPosts = posts.filter(post => {
        const contentLower = (post.contenido || '').toLowerCase();
        if (contentLower.includes(`@${searchName}`)) return true;
        
        // Tambi√©n revisar respuestas
        if (post.respuestas) {
          return post.respuestas.some(reply => {
            const replyLower = (reply.contenido || '').toLowerCase();
            return replyLower.includes(`@${searchName}`);
          });
        }
        return false;
      });
      
      const postsList = document.getElementById('posts-list');
      const emptyState = document.getElementById('empty-state');
      
      // Ocultar secci√≥n de escorts
      document.getElementById('escort-posts-section').style.display = 'none';
      
      // Actualizar t√≠tulo con filtro activo
      document.getElementById('section-title').innerHTML = `
        <span style="display: flex; align-items: center; gap: 12px;">
          <button onclick="clearMentionFilter()" style="background: rgba(212,175,55,0.2); border: 1px solid rgba(212,175,55,0.3); color: #D4AF37; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
            Limpiar filtro
          </button>
          <span>üí¨ Menciones de <span style="color: #D4AF37;">@${escapeHtml(profileName)}</span> (${filteredPosts.length})</span>
        </span>
      `;
      
      if (filteredPosts.length === 0) {
        postsList.innerHTML = '';
        emptyState.style.display = 'flex';
        document.getElementById('empty-message').textContent = `No se encontraron menciones de @${profileName}`;
      } else {
        emptyState.style.display = 'none';
        postsList.innerHTML = filteredPosts.map(post => renderPost(post)).join('');
      }
    }
    
    function clearMentionFilter() {
      mentionFilterActive = false;
      mentionFilterName = '';
      // Limpiar URL
      window.history.replaceState({}, document.title, window.location.pathname);
      // Ocultar indicador de filtro
      document.getElementById('mention-filter-active').style.display = 'none';
      document.getElementById('mention-filter-input').value = '';
      loadPosts('todos');
    }
    
    // Aplicar filtro desde el input
    function applyMentionFilter() {
      const input = document.getElementById('mention-filter-input');
      let searchValue = (input.value || '').trim();
      
      // Remover @ inicial si existe
      if (searchValue.startsWith('@')) {
        searchValue = searchValue.substring(1);
      }
      
      if (!searchValue) {
        alert('Ingresa un nombre para buscar menciones');
        return;
      }
      
      // Activar filtro
      mentionFilterActive = true;
      mentionFilterName = searchValue;
      
      // Mostrar indicador de filtro activo
      const filterActiveDiv = document.getElementById('mention-filter-active');
      const filterNameSpan = document.getElementById('mention-filter-name');
      filterActiveDiv.style.display = 'flex';
      filterNameSpan.textContent = `@${searchValue}`;
      
      // Cargar posts filtrados
      loadPostsFilteredByMention(searchValue);
    }
    
    // Event listener para buscar con Enter
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('mention-filter-input');
      if (input) {
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            applyMentionFilter();
          }
        });
      }
    });

    // ========================================
    // USUARIOS DE PRUEBA
    // ========================================
    function initTestUsers() {
      // Usuario de prueba
      const usuarios = JSON.parse(localStorage.getItem('salaOscuraUsuarios') || '[]');
      if (!usuarios.find(u => u.email === 'demo@demo.com')) {
        usuarios.push({
          id: 1,
          nombre: 'DemoUser',
          email: 'demo@demo.com',
          edad: 25,
          password: '123456',
          fechaRegistro: new Date().toISOString()
        });
        localStorage.setItem('salaOscuraUsuarios', JSON.stringify(usuarios));
      }

      // Escort de prueba
      const escorts = JSON.parse(localStorage.getItem('pendingRegistros') || '[]');
      if (!escorts.find(e => e.email === 'escort@demo.com')) {
        escorts.push({
          id: 2,
          name: 'Luna Bella',
          displayName: 'Luna Bella',
          email: 'escort@demo.com',
          status: 'aprobado',
          fechaRegistro: new Date().toISOString()
        });
        localStorage.setItem('pendingRegistros', JSON.stringify(escorts));
      }

      // Posts de ejemplo
      const posts = JSON.parse(localStorage.getItem('salaOscuraPosts') || '[]');
      if (posts.length === 0) {
        const ejemploPosts = [
          {
            id: Date.now(),
            autorId: 2,
            autorNombre: 'Luna Bella',
            autorTipo: 'escort',
            categoria: 'general',
            titulo: '¬°Bienvenidos a Sala Oscura!',
            contenido: 'Hola a todos, soy Luna Bella. Encantada de formar parte de esta comunidad. Estoy disponible para citas y me encanta conocer gente nueva. ¬°Espero que disfruten el foro!',
            rating: 0,
            fecha: new Date().toISOString(),
            respuestas: [],
            likes: 5,
            likedBy: []
          },
          {
            id: Date.now() + 1,
            autorId: 1,
            autorNombre: 'DemoUser',
            autorTipo: 'usuario',
            categoria: 'experiencias',
            titulo: 'Mi primera experiencia positiva',
            contenido: 'Quer√≠a compartir con ustedes una excelente experiencia que tuve recientemente. El trato fue muy profesional y amable. Definitivamente recomendado.',
            rating: 0,
            fecha: new Date().toISOString(),
            respuestas: [],
            likes: 3,
            likedBy: []
          }
        ];
        localStorage.setItem('salaOscuraPosts', JSON.stringify(ejemploPosts));
      }
    }

    // ========================================
    // MODALES
    // ========================================
    function openModal(modalId) {
      document.getElementById(`modal-${modalId}`).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(`modal-${modalId}`).classList.remove('active');
    }

    // Cerrar modal al hacer click fuera
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        e.target.classList.remove('active');
      }
    });

    // ========================================
    // ZONA CLIENTAS
    // ========================================
    function openZonaClientas() {
      // Solo escorts pueden acceder a Zona Clientas
      if (!currentUser) {
        alert('Debes iniciar sesi√≥n como Escort para acceder a esta zona.');
        openModal('login');
        return;
      }
      
      if (currentUser.tipo !== 'escort') {
        alert('‚ö†Ô∏è Acceso restringido\n\nEsta zona es exclusiva para Escorts verificadas.\nLos usuarios no pueden acceder a Zona Clientas.');
        return;
      }
      
      // Escort verificada, permitir acceso directo
      filterByCategory('zonaclientas');
    }

    // ========================================
    // TABS DE LOGIN
    // ========================================
    function switchLoginTab(type) {
      loginType = type;
      document.getElementById('tab-usuario').classList.toggle('active', type === 'usuario');
      document.getElementById('tab-escort').classList.toggle('active', type === 'escort');
      
      // Mostrar/ocultar campo de contrase√±a para escorts
      const passwordGroup = document.getElementById('login-password-group');
      const passwordInput = document.getElementById('login-password');
      
      // Elementos de crear cuenta (solo para usuarios)
      const noCuentaDiv = document.getElementById('login-no-cuenta');
      const crearCuentaBtn = document.getElementById('login-crear-cuenta');
      
      if (type === 'escort') {
        passwordGroup.style.display = 'none';
        passwordInput.removeAttribute('required');
        // Ocultar opci√≥n de crear cuenta para escorts
        noCuentaDiv.style.display = 'none';
        crearCuentaBtn.style.display = 'none';
      } else {
        passwordGroup.style.display = 'block';
        passwordInput.setAttribute('required', 'true');
        // Mostrar opci√≥n de crear cuenta para usuarios
        noCuentaDiv.style.display = 'flex';
        crearCuentaBtn.style.display = 'block';
      }
    }

    // ========================================
    // AUTENTICACI√ìN
    // ========================================
    function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim().toLowerCase();
      const password = document.getElementById('login-password').value;

      if (loginType === 'escort') {
        // Buscar en registros de escorts (pendingRegistros)
        const escorts = JSON.parse(localStorage.getItem('pendingRegistros') || '[]');
        const escort = escorts.find(e => e.email && e.email.toLowerCase() === email);
        
        if (escort) {
          // Login exitoso como escort
          currentUser = {
            id: escort.id,
            tipo: 'escort',
            nombre: escort.displayName || escort.artisticName || escort.name || 'Escort',
            email: escort.email,
            foto: escort.avatar || null,
            datos: escort
          };
          localStorage.setItem('salaOscuraCurrentUser', JSON.stringify(currentUser));
          closeModal('login');
          updateUI();
          loadPosts();
          alert('¬°Bienvenida! Has iniciado sesi√≥n como Escort.');
        } else {
          alert('No se encontr√≥ una cuenta de escort con ese correo. Aseg√∫rate de usar el correo con el que te registraste.');
        }
      } else {
        // Buscar en usuarios del foro
        const usuarios = JSON.parse(localStorage.getItem('salaOscuraUsuarios') || '[]');
        const usuario = usuarios.find(u => u.email.toLowerCase() === email && u.password === password);
        
        if (usuario) {
          currentUser = {
            id: usuario.id,
            tipo: 'usuario',
            nombre: usuario.nombre,
            email: usuario.email,
            edad: usuario.edad
          };
          localStorage.setItem('salaOscuraCurrentUser', JSON.stringify(currentUser));
          closeModal('login');
          updateUI();
          loadPosts();
          alert('¬°Bienvenido! Has iniciado sesi√≥n.');
        } else {
          alert('Correo o contrase√±a incorrectos.');
        }
      }
    }

    function handleRegister(e) {
      e.preventDefault();
      const nombre = document.getElementById('reg-nombre').value.trim();
      const email = document.getElementById('reg-email').value.trim().toLowerCase();
      const edad = parseInt(document.getElementById('reg-edad').value);
      const password = document.getElementById('reg-password').value;
      const ageConfirm = document.getElementById('reg-age-confirm').checked;

      if (edad < 18) {
        alert('Debes ser mayor de 18 a√±os para registrarte.');
        return;
      }

      if (!ageConfirm) {
        alert('Debes confirmar que eres mayor de edad.');
        return;
      }

      // Verificar si el email ya existe en usuarios del foro
      const usuarios = JSON.parse(localStorage.getItem('salaOscuraUsuarios') || '[]');
      if (usuarios.find(u => u.email.toLowerCase() === email)) {
        alert('Este correo ya est√° registrado como usuario del foro.');
        return;
      }

      // Verificar si el email ya existe como escort
      const escorts = JSON.parse(localStorage.getItem('pendingRegistros') || '[]');
      if (escorts.find(e => e.email && e.email.toLowerCase() === email)) {
        alert('Este correo ya est√° registrado como escort. Usa la opci√≥n "Soy Escort" para iniciar sesi√≥n.');
        return;
      }

      // Crear nuevo usuario
      const nuevoUsuario = {
        id: Date.now(),
        nombre,
        email,
        edad,
        password,
        fechaRegistro: new Date().toISOString()
      };

      usuarios.push(nuevoUsuario);
      localStorage.setItem('salaOscuraUsuarios', JSON.stringify(usuarios));

      // Login autom√°tico
      currentUser = {
        id: nuevoUsuario.id,
        tipo: 'usuario',
        nombre: nuevoUsuario.nombre,
        email: nuevoUsuario.email,
        edad: nuevoUsuario.edad
      };
      localStorage.setItem('salaOscuraCurrentUser', JSON.stringify(currentUser));

      closeModal('register');
      updateUI();
      loadPosts();
      alert('¬°Cuenta creada exitosamente! Ya puedes participar en el foro.');
    }

    function cerrarSesion() {
      currentUser = null;
      localStorage.removeItem('salaOscuraCurrentUser');
      updateUI();
    }
    
    // Ir a inicio cerrando sesi√≥n autom√°ticamente
    function irAInicio(e) {
      e.preventDefault();
      // Cerrar sesi√≥n si hay usuario logueado
      if (currentUser) {
        currentUser = null;
        localStorage.removeItem('salaOscuraCurrentUser');
      }
      // Redirigir a p√°gina principal
      window.location.href = 'home';
    }

    // ========================================
    // ACTUALIZAR UI
    // ========================================
    function updateUI() {
      const heroSection = document.getElementById('hero-section');
      const foroContent = document.getElementById('foro-content');
      const authButtons = document.getElementById('nav-auth-buttons');
      const userInfo = document.getElementById('nav-user-info');

      if (currentUser) {
        heroSection.style.display = 'none';
        foroContent.classList.add('active');
        authButtons.style.display = 'none';
        userInfo.style.display = 'flex';

        // Actualizar info del usuario
        document.getElementById('user-avatar').textContent = currentUser.nombre.charAt(0).toUpperCase();
        document.getElementById('user-display-name').textContent = currentUser.nombre;
        document.getElementById('welcome-name').textContent = currentUser.nombre;

        // Mostrar badge si es escort
        const badge = document.getElementById('user-badge');
        if (currentUser.tipo === 'escort') {
          badge.style.display = 'inline';
          badge.textContent = 'ESCORT';
        } else {
          badge.style.display = 'none';
        }
        
        // Controlar visibilidad de opci√≥n Zona Clientas en selector de categor√≠as
        updateZonaClientasVisibility();
      } else {
        heroSection.style.display = 'block';
        foroContent.classList.remove('active');
        authButtons.style.display = 'block';
        userInfo.style.display = 'none';
        
        // Ocultar opci√≥n Zona Clientas cuando no hay usuario
        updateZonaClientasVisibility();
      }
    }
    
    // Controlar visibilidad de Zona Clientas seg√∫n tipo de usuario
    function updateZonaClientasVisibility() {
      const zonaClientasOption = document.querySelector('#post-category option[value="zonaclientas"]');
      const zonaClientasCard = document.querySelector('.foro-category.zona-clientas');
      
      const isEscort = currentUser && currentUser.tipo === 'escort';
      
      // Ocultar/mostrar opci√≥n en selector de categor√≠as
      if (zonaClientasOption) {
        zonaClientasOption.style.display = isEscort ? 'block' : 'none';
        zonaClientasOption.disabled = !isEscort;
      }
      
      // Mostrar/ocultar mensaje en la tarjeta de Zona Clientas
      if (zonaClientasCard) {
        const countDiv = zonaClientasCard.querySelector('.foro-category-count');
        if (countDiv) {
          if (isEscort) {
            // Mostrar contador real para escorts
            const posts = JSON.parse(localStorage.getItem('salaOscuraPosts') || '[]');
            const count = posts.filter(p => p.categoria === 'zonaclientas').length;
            countDiv.innerHTML = `${count} tema${count !== 1 ? 's' : ''}`;
          } else {
            countDiv.innerHTML = 'üîí Solo Escorts';
          }
        }
      }
    }

    // ========================================
    // POSTS
    // ========================================
    function loadPosts(filter = 'todos') {
      currentFilter = filter;
      
      // Si es zona clientas, verificar que sea escort
      if (filter === 'zonaclientas') {
        if (!currentUser) {
          alert('Debes iniciar sesi√≥n como Escort para acceder a esta zona.');
          openModal('login');
          return;
        }
        if (currentUser.tipo !== 'escort') {
          alert('‚ö†Ô∏è Acceso restringido\n\nEsta zona es exclusiva para Escorts verificadas.');
          loadPosts('todos');
          return;
        }
      }
      
      const posts = JSON.parse(localStorage.getItem('salaOscuraPosts') || '[]');
      
      let filteredPosts = posts;
      if (filter === 'todos') {
        // REGLA: En vista general, EXCLUIR posts de Zona Clientas (zona aislada)
        filteredPosts = posts.filter(p => p.categoria !== 'zonaclientas');
      } else {
        filteredPosts = posts.filter(p => p.categoria === filter);
      }

      // Separar posts de escorts y usuarios
      const escortPosts = filteredPosts.filter(p => p.autorTipo === 'escort');
      const userPosts = filteredPosts.filter(p => p.autorTipo !== 'escort');

      // Renderizar posts de escorts
      const escortList = document.getElementById('escort-posts-list');
      const escortSection = document.getElementById('escort-posts-section');
      
      if (escortPosts.length > 0) {
        escortSection.style.display = 'block';
        escortList.innerHTML = escortPosts.map(renderPost).join('');
      } else {
        escortSection.style.display = 'none';
      }

      // Renderizar posts de usuarios
      const postsList = document.getElementById('posts-list');
      const emptyState = document.getElementById('empty-state');
      
      if (userPosts.length > 0) {
        postsList.innerHTML = userPosts.map(renderPost).join('');
        emptyState.style.display = 'none';
      } else if (escortPosts.length === 0) {
        postsList.innerHTML = '';
        emptyState.style.display = 'block';
      } else {
        postsList.innerHTML = '';
        emptyState.style.display = 'none';
      }

      // Actualizar t√≠tulo
      const titles = {
        'todos': 'Publicaciones Recientes',
        'general': 'üí¨ Discusi√≥n General',
        'calificaciones': '‚≠ê Calificaciones',
        'recomendaciones': 'üëç Recomendaciones',
        'experiencias': 'üìñ Experiencias',
        'zonaclientas': 'üë† Zona Clientas'
      };
      document.getElementById('section-title').textContent = titles[filter] || 'Publicaciones';
    }

    // Renderizar post en modo compacto (lista) o expandido (detalle)
    function renderPost(post, expanded = false) {
      const fecha = new Date(post.fecha).toLocaleDateString('es-ES', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });

      const isEscort = post.autorTipo === 'escort';
      const categoryLabels = {
        'general': 'üí¨ General',
        'calificaciones': '‚≠ê Calificaci√≥n',
        'recomendaciones': 'üëç Recomendaci√≥n',
        'experiencias': 'üìñ Experiencia',
        'zonaclientas': 'üë† Zona Clientas'
      };

      // Verificar si el usuario actual ya dio like
      const userLikeId = currentUser ? `${currentUser.tipo}_${currentUser.id}` : null;
      const hasLiked = post.likedBy && userLikeId && post.likedBy.includes(userLikeId);

      // Modo compacto: solo t√≠tulo, autor, fecha y stats
      if (!expanded) {
        return `
          <div class="foro-post foro-post-compact ${isEscort ? 'escort-post' : ''}" onclick="expandirPost(${post.id})" style="cursor: pointer;">
            <div class="foro-post-header">
              <div class="foro-post-author">
                <div class="foro-post-avatar">${post.autorNombre.charAt(0).toUpperCase()}</div>
                <div class="foro-post-author-info">
                  <span class="foro-post-author-name">
                    ${escapeHtml(post.autorNombre)}
                    ${isEscort ? '<span class="foro-user-badge">ESCORT</span>' : ''}
                  </span>
                  <span class="foro-post-date">${fecha}</span>
                </div>
              </div>
              <span class="foro-post-category">${categoryLabels[post.categoria] || post.categoria}</span>
            </div>
            
            <h3 class="foro-post-title" style="margin-bottom: 8px;">${escapeHtml(post.titulo)}</h3>
            
            <div class="foro-post-footer" style="border-top: none; padding-top: 0;">
              <div class="foro-post-stats">
                <span class="foro-post-stat">üí¨ ${post.respuestas ? post.respuestas.length : 0}</span>
                <span class="foro-post-stat">üëç ${post.likes || 0}</span>
              </div>
              <span style="color: var(--gold); font-size: 12px;">Clic para ver m√°s ‚Üí</span>
            </div>
          </div>
        `;
      }

      // Modo expandido: contenido completo con ratings y respuestas
      let ratingHTML = '';
      if (post.ratings && (post.categoria === 'calificaciones' || post.categoria === 'recomendaciones')) {
        const r = post.ratings;
        ratingHTML = `
          <div class="foro-detailed-ratings" style="background: rgba(212,175,55,0.08); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--muted); font-size: 13px;">üõèÔ∏è Habitaci√≥n</span>
                <span style="color: var(--gold); font-weight: 700;">${r.habitacion || 0}/10</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--muted); font-size: 13px;">üíÉ La Chica</span>
                <span style="color: var(--gold); font-weight: 700;">${r.chica || 0}/10</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--muted); font-size: 13px;">üî• Servicio</span>
                <span style="color: var(--gold); font-weight: 700;">${r.servicio || 0}/10</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--muted); font-size: 13px;">üßº Higiene</span>
                <span style="color: var(--gold); font-weight: 700;">${r.higiene || 0}/10</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--muted); font-size: 13px;">üòä Trato</span>
                <span style="color: var(--gold); font-weight: 700;">${r.trato || 0}/10</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--muted); font-size: 13px;">üí∞ Precio</span>
                <span style="color: var(--gold); font-weight: 700;">${r.precio || 0}/10</span>
              </div>
            </div>
            <div style="text-align: center; padding-top: 12px; border-top: 1px solid rgba(212,175,55,0.2);">
              <span style="color: var(--muted); font-size: 14px;">Promedio General: </span>
              <span style="color: var(--gold); font-weight: 700; font-size: 24px;">${post.rating || 0}</span>
              <span style="color: var(--muted); font-size: 14px;">/10</span>
            </div>
          </div>
        `;
      } else if (post.rating && post.rating > 0) {
        ratingHTML = `
          <div class="foro-rating">
            <span class="foro-rating-score">${post.rating}</span>
            <span class="foro-rating-max">/10</span>
          </div>
        `;
      }

      let repliesHTML = '';
      if (post.respuestas && post.respuestas.length > 0) {
        repliesHTML = `
          <div class="foro-replies">
            <h4 class="foro-replies-title">üí¨ ${post.respuestas.length} respuesta${post.respuestas.length > 1 ? 's' : ''}</h4>
            ${post.respuestas.map(r => `
              <div class="foro-reply">
                <div class="foro-reply-header">
                  <span class="foro-reply-author">${r.autorNombre}</span>
                  ${r.autorTipo === 'escort' ? '<span class="foro-user-badge">ESCORT</span>' : ''}
                  <span class="foro-reply-date">${new Date(r.fecha).toLocaleDateString('es-ES')}</span>
                </div>
                <p class="foro-reply-content">${processMentions(r.contenido)}</p>
              </div>
            `).join('')}
          </div>
        `;
      }

      return `
        <div class="foro-post ${isEscort ? 'escort-post' : ''}">
          <div class="foro-post-header">
            <div class="foro-post-author">
              <div class="foro-post-avatar">${post.autorNombre.charAt(0).toUpperCase()}</div>
              <div class="foro-post-author-info">
                <span class="foro-post-author-name">
                  ${escapeHtml(post.autorNombre)}
                  ${isEscort ? '<span class="foro-user-badge">ESCORT</span>' : ''}
                </span>
                <span class="foro-post-date">${fecha}</span>
              </div>
            </div>
            <span class="foro-post-category">${categoryLabels[post.categoria] || post.categoria}</span>
          </div>
          
          <h3 class="foro-post-title">${escapeHtml(post.titulo)}</h3>
          <p class="foro-post-content">${processMentions(post.contenido)}</p>
          
          ${ratingHTML}
          
          <div class="foro-post-footer">
            <div class="foro-post-stats">
              <span class="foro-post-stat">üí¨ ${post.respuestas ? post.respuestas.length : 0}</span>
              <span class="foro-post-stat">üëç ${post.likes || 0}</span>
            </div>
            <div class="foro-post-actions">
              <button class="foro-post-action" onclick="abrirResponder(${post.id})">Responder</button>
              <button class="foro-post-action ${hasLiked ? 'liked' : ''}" onclick="darLike(${post.id})" ${hasLiked ? 'style="background: rgba(212,175,55,0.2); color: var(--gold); border-color: var(--gold);"' : ''}>
                ${hasLiked ? '‚úì Te gusta' : 'üëç Like'}
              </button>
            </div>
          </div>
          
          ${repliesHTML}
        </div>
      `;
    }
    
    // Expandir un post para ver su contenido completo
    function expandirPost(postId) {
      const posts = JSON.parse(localStorage.getItem('salaOscuraPosts') || '[]');
      const post = posts.find(p => p.id === postId);
      
      if (!post) {
        alert('Post no encontrado');
        return;
      }
      
      // Verificar acceso a Zona Clientas
      if (post.categoria === 'zonaclientas') {
        if (!currentUser || currentUser.tipo !== 'escort') {
          alert('‚ö†Ô∏è Acceso restringido\n\nEste hilo es de Zona Clientas, exclusiva para Escorts.');
          return;
        }
      }
      
      currentFilter = 'hilo';
      
      // Ocultar secci√≥n de escorts en vista de hilo √∫nico
      document.getElementById('escort-posts-section').style.display = 'none';
      
      // Mostrar post expandido
      const postsList = document.getElementById('posts-list');
      const emptyState = document.getElementById('empty-state');
      
      postsList.innerHTML = renderPost(post, true); // true = expandido
      emptyState.style.display = 'none';
      
      // Actualizar t√≠tulo con bot√≥n de volver
      document.getElementById('section-title').innerHTML = `
        <span style="display: flex; align-items: center; gap: 12px;">
          <button onclick="volverALista()" style="background: rgba(212,175,55,0.2); border: 1px solid rgba(212,175,55,0.3); color: #D4AF37; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            Volver
          </button>
          <span>üìå ${escapeHtml(post.titulo)}</span>
        </span>
      `;
      
      // Scroll al post
      postsList.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // Volver a la lista de posts
    function volverALista() {
      window.history.replaceState({}, document.title, window.location.pathname);
      document.getElementById('section-title').textContent = 'Publicaciones Recientes';
      loadPosts(currentFilter === 'hilo' ? 'todos' : currentFilter);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function filterByCategory(categoria) {
      loadPosts(categoria);
    }

    function updateCategoryCounts() {
      const posts = JSON.parse(localStorage.getItem('salaOscuraPosts') || '[]');
      
      const counts = {
        general: posts.filter(p => p.categoria === 'general').length,
        calificaciones: posts.filter(p => p.categoria === 'calificaciones').length,
        recomendaciones: posts.filter(p => p.categoria === 'recomendaciones').length,
        experiencias: posts.filter(p => p.categoria === 'experiencias').length,
        zonaclientas: posts.filter(p => p.categoria === 'zonaclientas').length
      };

      document.getElementById('count-general').textContent = `${counts.general} tema${counts.general !== 1 ? 's' : ''}`;
      document.getElementById('count-calificaciones').textContent = `${counts.calificaciones} tema${counts.calificaciones !== 1 ? 's' : ''}`;
      document.getElementById('count-recomendaciones').textContent = `${counts.recomendaciones} tema${counts.recomendaciones !== 1 ? 's' : ''}`;
      document.getElementById('count-experiencias').textContent = `${counts.experiencias} tema${counts.experiencias !== 1 ? 's' : ''}`;
      
      // Zona clientas muestra temas solo si es escort
      const zonaCountEl = document.getElementById('count-zonaclientas');
      if (currentUser && currentUser.tipo === 'escort') {
        zonaCountEl.textContent = `${counts.zonaclientas} tema${counts.zonaclientas !== 1 ? 's' : ''}`;
      } else {
        zonaCountEl.textContent = 'üîí Solo Escorts';
      }
    }

    // ========================================
    // CREAR POST
    // ========================================
    function handleCategoryChange() {
      const category = document.getElementById('post-category').value;
      const ratingGroup = document.getElementById('rating-group');
      
      if (category === 'calificaciones' || category === 'recomendaciones') {
        ratingGroup.style.display = 'block';
      } else {
        ratingGroup.style.display = 'none';
      }
    }

    function initRatingButtons() {
      document.querySelectorAll('.rating-input').forEach(container => {
        const field = container.dataset.field;
        container.querySelectorAll('.rating-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            // Remover selecci√≥n anterior en este grupo
            container.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            
            // Guardar valor
            const inputId = field ? `rating-${field}` : 'post-rating';
            const input = document.getElementById(inputId);
            if (input) {
              input.value = this.dataset.rating;
            }
            
            // Actualizar promedio
            updateRatingPromedio();
          });
        });
      });
    }

    function updateRatingPromedio() {
      const fields = ['habitacion', 'chica', 'servicio', 'higiene', 'trato', 'precio'];
      let total = 0;
      let count = 0;
      
      fields.forEach(field => {
        const val = parseInt(document.getElementById(`rating-${field}`).value) || 0;
        if (val > 0) {
          total += val;
          count++;
        }
      });
      
      const promedio = count > 0 ? (total / count).toFixed(1) : 0;
      document.getElementById('rating-promedio').textContent = promedio;
      document.getElementById('post-rating').value = promedio;
    }

    function handleNewPost(e) {
      e.preventDefault();
      
      if (!currentUser) {
        alert('Debes iniciar sesi√≥n para publicar.');
        return;
      }

      const categoria = document.getElementById('post-category').value;
      const titulo = document.getElementById('post-title').value.trim();
      const contenido = document.getElementById('post-content').value.trim();
      
      // Verificar que solo escorts pueden publicar en Zona Clientas
      if (categoria === 'zonaclientas' && currentUser.tipo !== 'escort') {
        alert('‚ö†Ô∏è Acceso restringido\n\nSolo las Escorts pueden publicar en Zona Clientas.');
        return;
      }
      
      // Recoger calificaciones detalladas
      const ratings = {
        habitacion: parseInt(document.getElementById('rating-habitacion').value) || 0,
        chica: parseInt(document.getElementById('rating-chica').value) || 0,
        servicio: parseInt(document.getElementById('rating-servicio').value) || 0,
        higiene: parseInt(document.getElementById('rating-higiene').value) || 0,
        trato: parseInt(document.getElementById('rating-trato').value) || 0,
        precio: parseInt(document.getElementById('rating-precio').value) || 0
      };
      
      const rating = parseFloat(document.getElementById('post-rating').value) || 0;

      const posts = JSON.parse(localStorage.getItem('salaOscuraPosts') || '[]');

      const nuevoPost = {
        id: Date.now(),
        autorId: currentUser.id,
        autorNombre: currentUser.nombre,
        autorTipo: currentUser.tipo,
        categoria,
        titulo,
        contenido,
        rating: (categoria === 'calificaciones' || categoria === 'recomendaciones') ? rating : 0,
        ratings: (categoria === 'calificaciones' || categoria === 'recomendaciones') ? ratings : null,
        fecha: new Date().toISOString(),
        respuestas: [],
        likes: 0,
        likedBy: []
      };

      posts.unshift(nuevoPost);
      localStorage.setItem('salaOscuraPosts', JSON.stringify(posts));

      // Extraer y guardar menciones
      extractAndSaveMentions(contenido, nuevoPost.id, titulo, currentUser.nombre);

      // Reset form
      document.getElementById('newpost-form').reset();
      document.getElementById('post-rating').value = '0';
      document.getElementById('rating-habitacion').value = '0';
      document.getElementById('rating-chica').value = '0';
      document.getElementById('rating-servicio').value = '0';
      document.getElementById('rating-higiene').value = '0';
      document.getElementById('rating-trato').value = '0';
      document.getElementById('rating-precio').value = '0';
      document.getElementById('rating-promedio').textContent = '0';
      document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('selected'));
      document.getElementById('rating-group').style.display = 'none';

      closeModal('newpost');
      loadPosts(currentFilter);
      updateCategoryCounts();
      alert('¬°Publicaci√≥n creada exitosamente!');
    }

    // ========================================
    // RESPUESTAS Y LIKES
    // ========================================
    function abrirResponder(postId) {
      if (!currentUser) {
        alert('Debes iniciar sesi√≥n para responder.');
        openModal('login');
        return;
      }
      
      // Verificar si el post es de Zona Clientas
      const posts = JSON.parse(localStorage.getItem('salaOscuraPosts') || '[]');
      const post = posts.find(p => p.id === postId);
      if (post && post.categoria === 'zonaclientas' && currentUser.tipo !== 'escort') {
        alert('‚ö†Ô∏è Acceso restringido\n\nSolo las Escorts pueden responder en Zona Clientas.');
        return;
      }
      
      document.getElementById('reply-post-id').value = postId;
      openModal('reply');
    }

    function handleReply(e) {
      e.preventDefault();
      
      const postId = parseInt(document.getElementById('reply-post-id').value);
      const contenido = document.getElementById('reply-content').value.trim();

      const posts = JSON.parse(localStorage.getItem('salaOscuraPosts') || '[]');
      const post = posts.find(p => p.id === postId);

      if (post) {
        // Verificar si es Zona Clientas y el usuario no es escort
        if (post.categoria === 'zonaclientas' && currentUser.tipo !== 'escort') {
          alert('‚ö†Ô∏è Acceso restringido\n\nSolo las Escorts pueden responder en Zona Clientas.');
          return;
        }
        
        if (!post.respuestas) post.respuestas = [];
        
        const replyId = Date.now();
        post.respuestas.push({
          id: replyId,
          autorId: currentUser.id,
          autorNombre: currentUser.nombre,
          autorTipo: currentUser.tipo,
          contenido,
          fecha: new Date().toISOString()
        });

        localStorage.setItem('salaOscuraPosts', JSON.stringify(posts));
        
        // Extraer y guardar menciones
        extractAndSaveMentions(contenido, postId, post.titulo, currentUser.nombre);
        
        document.getElementById('reply-form').reset();
        closeModal('reply');
        
        // Si estamos viendo un hilo espec√≠fico, mantenerlo abierto
        if (currentFilter === 'hilo') {
          showSpecificPost(postId);
        } else {
          loadPosts(currentFilter);
        }
      }
    }

    function darLike(postId) {
      if (!currentUser) {
        alert('Debes iniciar sesi√≥n para dar like.');
        return;
      }

      const posts = JSON.parse(localStorage.getItem('salaOscuraPosts') || '[]');
      const post = posts.find(p => p.id === postId);

      if (post) {
        // Inicializar array de likes si no existe
        if (!post.likedBy) {
          post.likedBy = [];
        }
        
        // Crear identificador √∫nico del usuario
        const userLikeId = `${currentUser.tipo}_${currentUser.id}`;
        
        // Verificar si ya dio like
        if (post.likedBy.includes(userLikeId)) {
          // Quitar like (toggle)
          post.likedBy = post.likedBy.filter(id => id !== userLikeId);
          post.likes = Math.max(0, (post.likes || 1) - 1);
        } else {
          // Dar like
          post.likedBy.push(userLikeId);
          post.likes = (post.likes || 0) + 1;
        }
        
        localStorage.setItem('salaOscuraPosts', JSON.stringify(posts));
        loadPosts(currentFilter);
      }
    }

    // ========================================
    // SISTEMA DE MENCIONES @
    // ========================================
    let activeAutocomplete = null;
    let selectedMentionIndex = -1;
    let mentionableUsers = [];

    // Obtener todos los usuarios mencionables (clientas aprobadas)
    function getMentionableUsers() {
      const users = [];
      
      // Obtener de approvedUsers (clientas aprobadas)
      const approvedUsers = JSON.parse(localStorage.getItem('approvedUsers') || '[]');
      approvedUsers.forEach(u => {
        if (u.status === 'aprobado') {
          users.push({
            id: u.id,
            email: u.email,
            name: u.displayName || u.artisticName || u.name || 'Clienta',
            type: 'clienta',
            avatar: u.avatar || null
          });
        }
      });
      
      // Tambi√©n de pendingRegistros con status aprobado (escorts)
      const pendingRegistros = JSON.parse(localStorage.getItem('pendingRegistros') || '[]');
      pendingRegistros.forEach(e => {
        if (e.status === 'aprobado' && !users.find(u => u.email === e.email)) {
          users.push({
            id: e.id,
            email: e.email,
            name: e.displayName || e.artisticName || e.name || 'Escort',
            type: 'escort',
            avatar: e.avatar || null
          });
        }
      });
      
      // Tambi√©n de approvedProfiles
      const approvedProfiles = JSON.parse(localStorage.getItem('approvedProfiles') || '[]');
      approvedProfiles.forEach(p => {
        if (!users.find(u => u.email === p.email)) {
          users.push({
            id: p.id,
            email: p.email,
            name: p.displayName || p.artisticName || p.name || 'Perfil',
            type: 'perfil',
            avatar: p.avatar || null
          });
        }
      });
      
      return users;
    }

    // Inicializar sistema de menciones en un textarea
    function initMentionSystem(textareaId, autocompleteId) {
      const textarea = document.getElementById(textareaId);
      const autocomplete = document.getElementById(autocompleteId);
      
      if (!textarea || !autocomplete) return;
      
      textarea.addEventListener('input', (e) => handleMentionInput(e, textarea, autocomplete));
      textarea.addEventListener('keydown', (e) => handleMentionKeydown(e, textarea, autocomplete));
      textarea.addEventListener('blur', () => {
        setTimeout(() => hideMentionAutocomplete(autocomplete), 200);
      });
    }

    function handleMentionInput(e, textarea, autocomplete) {
      const value = textarea.value;
      const cursorPos = textarea.selectionStart;
      
      // Buscar @ antes del cursor
      const textBeforeCursor = value.substring(0, cursorPos);
      const atIndex = textBeforeCursor.lastIndexOf('@');
      
      if (atIndex !== -1) {
        // Verificar que no haya espacio entre @ y cursor
        const textAfterAt = textBeforeCursor.substring(atIndex + 1);
        
        if (!textAfterAt.includes(' ') && !textAfterAt.includes('\n')) {
          const searchTerm = textAfterAt.toLowerCase();
          showMentionAutocomplete(searchTerm, textarea, autocomplete);
          return;
        }
      }
      
      hideMentionAutocomplete(autocomplete);
    }

    function showMentionAutocomplete(searchTerm, textarea, autocomplete) {
      mentionableUsers = getMentionableUsers();
      
      const filtered = mentionableUsers.filter(u => 
        u.name.toLowerCase().includes(searchTerm)
      );
      
      if (filtered.length === 0) {
        autocomplete.innerHTML = '<div class="mention-empty">No se encontraron usuarios</div>';
      } else {
        autocomplete.innerHTML = filtered.map((user, index) => `
          <div class="mention-item ${index === 0 ? 'selected' : ''}" 
               data-name="${escapeHtml(user.name)}" 
               data-email="${user.email}"
               data-id="${user.id}"
               onclick="selectMention(this, '${textarea.id}', '${autocomplete.id}')">
            <div class="mention-item-avatar">${user.name.charAt(0).toUpperCase()}</div>
            <div class="mention-item-info">
              <span class="mention-item-name">${escapeHtml(user.name)}</span>
              <span class="mention-item-badge">${user.type === 'escort' ? '‚ú® Escort' : 'üë† Clienta'}</span>
            </div>
          </div>
        `).join('');
      }
      
      // Posicionar autocomplete
      const rect = textarea.getBoundingClientRect();
      autocomplete.style.top = `${textarea.offsetHeight + 4}px`;
      autocomplete.style.left = '0';
      autocomplete.classList.add('active');
      activeAutocomplete = autocomplete;
      selectedMentionIndex = filtered.length > 0 ? 0 : -1;
    }

    function hideMentionAutocomplete(autocomplete) {
      if (autocomplete) {
        autocomplete.classList.remove('active');
      }
      activeAutocomplete = null;
      selectedMentionIndex = -1;
    }

    function handleMentionKeydown(e, textarea, autocomplete) {
      if (!autocomplete.classList.contains('active')) return;
      
      const items = autocomplete.querySelectorAll('.mention-item');
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedMentionIndex = Math.min(selectedMentionIndex + 1, items.length - 1);
        updateSelectedMention(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedMentionIndex = Math.max(selectedMentionIndex - 1, 0);
        updateSelectedMention(items);
      } else if (e.key === 'Enter' || e.key === 'Tab') {
        if (selectedMentionIndex >= 0 && items[selectedMentionIndex]) {
          e.preventDefault();
          selectMention(items[selectedMentionIndex], textarea.id, autocomplete.id);
        }
      } else if (e.key === 'Escape') {
        hideMentionAutocomplete(autocomplete);
      }
    }

    function updateSelectedMention(items) {
      items.forEach((item, index) => {
        item.classList.toggle('selected', index === selectedMentionIndex);
      });
    }

    function selectMention(element, textareaId, autocompleteId) {
      const textarea = document.getElementById(textareaId);
      const autocomplete = document.getElementById(autocompleteId);
      const name = element.dataset.name;
      
      const value = textarea.value;
      const cursorPos = textarea.selectionStart;
      const textBeforeCursor = value.substring(0, cursorPos);
      const atIndex = textBeforeCursor.lastIndexOf('@');
      
      if (atIndex !== -1) {
        const before = value.substring(0, atIndex);
        const after = value.substring(cursorPos);
        
        textarea.value = before + '@' + name + ' ' + after;
        
        // Mover cursor despu√©s del nombre
        const newCursorPos = atIndex + name.length + 2;
        textarea.setSelectionRange(newCursorPos, newCursorPos);
        textarea.focus();
      }
      
      hideMentionAutocomplete(autocomplete);
    }

    // Convertir menciones @ en links clickeables
    function processMentions(text) {
      const users = getMentionableUsers();
      let processedText = escapeHtml(text);
      
      // Buscar todas las menciones @nombre
      const mentionRegex = /@(\w+(?:\s\w+)*)/g;
      
      processedText = processedText.replace(mentionRegex, (match, name) => {
        // Buscar usuario que coincida
        const user = users.find(u => u.name.toLowerCase() === name.toLowerCase());
        
        if (user) {
          return `<a href="#" class="mention-link" onclick="goToProfile('${user.email}'); return false;">@${escapeHtml(user.name)}</a>`;
        }
        return match;
      });
      
      return processedText;
    }

    // Navegar al perfil de la clienta mencionada
    function goToProfile(email) {
      // Buscar en approvedUsers
      const approvedUsers = JSON.parse(localStorage.getItem('approvedUsers') || '[]');
      const user = approvedUsers.find(u => u.email === email);
      
      if (user && user.id) {
        // Redirigir a la p√°gina principal con el perfil
        window.location.href = `home?profile=${user.id}`;
      } else {
        alert('Perfil no encontrado');
      }
    }

    // Extraer menciones de un texto y guardar notificaciones
    function extractAndSaveMentions(text, postId, postTitle, autorNombre) {
      const users = getMentionableUsers();
      const mentionRegex = /@(\w+(?:\s\w+)*)/g;
      let match;
      
      while ((match = mentionRegex.exec(text)) !== null) {
        const name = match[1];
        const user = users.find(u => u.name.toLowerCase() === name.toLowerCase());
        
        if (user) {
          // Guardar menci√≥n para el usuario
          saveMention(user.email, {
            postId,
            postTitle,
            mentionedBy: autorNombre,
            fecha: new Date().toISOString(),
            read: false
          });
        }
      }
    }

    // Guardar menci√≥n en localStorage
    function saveMention(userEmail, mentionData) {
      const mentions = JSON.parse(localStorage.getItem('salaOscuraMentions') || '{}');
      
      if (!mentions[userEmail]) {
        mentions[userEmail] = [];
      }
      
      mentions[userEmail].unshift(mentionData);
      localStorage.setItem('salaOscuraMentions', JSON.stringify(mentions));
    }

    // Obtener menciones de un usuario
    function getMentionsForUser(email) {
      const mentions = JSON.parse(localStorage.getItem('salaOscuraMentions') || '{}');
      return mentions[email] || [];
    }

    // Inicializar sistema de menciones al cargar
    document.addEventListener('DOMContentLoaded', () => {
      initMentionSystem('post-content', 'post-autocomplete');
      initMentionSystem('reply-content', 'reply-autocomplete');
    });
  </script>
  <script src="config.js"></script>
  <script src="api.js"></script>
  <script src="url-handler.js"></script>
</body>
</html>
